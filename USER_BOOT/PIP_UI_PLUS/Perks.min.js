eval(fs.readFile("USER_BOOT/PIP_UI_PLUS/Menu.min.js"));const ENABLED_PERKS_PATH="USER_BOOT/PIP_UI_PLUS/PERKS/_enabled_perks.dat",PERKS_PATH="USER_BOOT/PIP_UI_PLUS/PERKS/_perks.dat";function insertSorted(e,t){let r=0,n=e.length;for(;r<n;){var i=r+n>>1,a=e[i];if(a==t)return!1;a<t?r=1+i:n=i}return e.splice(r,0,t),!0}function remove(e,t){t=e.indexOf(t);return!(t<0||(e.splice(t,1),0))}class PerkEntry extends Entry{static STAR_IMAGE={width:11,height:11,bpp:1};static FILLED_STAR_BUFFER=atob("BAHAOH///v+P4fx7zjmDAA==");static HOLLOW_STAR_BUFFER=atob("BAFAKHj4AoCIISRKSimDAA==");static STAR_GAP=2;constructor(e){super(e),this.column.replace(2,this.drawStars.bind(this),20)}get description(){return this.data.d[Math.max(0,this.data.r-1)]}drawStars(e){var t=PerkEntry.STAR_IMAGE,r=PerkEntry.STAR_GAP,n=this.data.d.length,i=n*(t.width+r)-r,a=e.left+e.right-i>>1,s=e.top+e.bottom-t.height>>1;for(let e=0;e<n;++e){var d=e+1<=this.data.r;t.buffer=d?PerkEntry.FILLED_STAR_BUFFER:PerkEntry.HOLLOW_STAR_BUFFER,bC.drawImage(t,a+e*(t.width+r),s,{scale:1})}}}class PerkEditorEntry extends PerkEntry{constructor(e,t,r,n){super(e),this.index=t,this.array=r,this.indices=n}get value(){return this.data.r}set value(e){this.data.r=e}get min(){return 0}get max(){return this.data.d.length}onchange(e){this.array.set(this.index,this.data),(0==e?remove:insertSorted)(this.indices,this.index)&&fs.writeFile(ENABLED_PERKS_PATH,this.indices.join(","))}}class IndexedFileBackedArray extends FileBackedArray{constructor(e,t){super(e.readableFile,e.writableFile,-1,e.lineLength),this.indices=t}get length(){return this.indices?this.indices.length:-1}set length(e){}get(e){return super.get(this.indices[e])}}Pip.removeSubmenu&&Pip.removeSubmenu();const enabledPerkIndices=fs.readFile(ENABLED_PERKS_PATH).split(",").map(e=>parseInt(e)),perksArray=new FileBackedArray(E.openFile(PERKS_PATH),E.openFile(PERKS_PATH,"w+"),74,701).lazyMap((e,t,r)=>new PerkEditorEntry(e,t,r,enabledPerkIndices)),enabledPerksArray=new IndexedFileBackedArray(perksArray,enabledPerkIndices).lazyMap(e=>new PerkEntry(e));let menu=null,editorEnabled=!1;function swapMenu(){menu&&(menu.close(),Pip.audioStartVar(Pip.audioBuiltin("OK"))),(menu=editorEnabled?new Menu({x2:190,titlePadX:5,compact:!0,wrap:!0},perksArray):new Menu({x2:190,compact:!0},enabledPerksArray)).show(),editorEnabled=!editorEnabled}function resetTorchHandler(e){Pip.removeAllListeners("torch"),Pip.on("torch",e)}swapMenu(),resetTorchHandler(swapMenu),Pip.removeSubmenu=()=>{perksArray.close(),menu.close(),resetTorchHandler(torchButtonHandler)};