const mod=(t,i)=>(t%i+i)%i,wrap=(t,i,e)=>mod(t-i,e-i+1)+i,copy=t=>Object.assign(Object.create(Object.getPrototypeOf(t)),t);class FileBackedArray{constructor(t,i,e,s){this.readableFile=t,this.writableFile=i,this.length=e,this.lineLength=s}get(t){this.readableFile.seek(t*this.lineLength);t=this.readableFile.read(this.lineLength);return null!=t?JSON.parse(t):t}set(t,i){this.writableFile.seek(t*this.lineLength),this.writableFile.write(JSON.stringify(i).padEnd(this.lineLength," "))}slice(i,e){e=null==e?this.length:e,i=0<=(i=null==i?0:i)?Math.min(i,this.length):Math.max(i+this.length,0),e=0<=e?Math.min(e,this.length):Math.max(e+this.length,0);var s=[];for(let t=i;t<e;++t)s.push(this.get(t));return s}lazyMap(e){var t=copy(this);const s=this.get.bind(this);return t.get=t=>{var i=s(t);return null!=i?e(i,t,this):i},t}close(){this.readableFile.close(),this.writableFile.close()}}class CachingWindow{constructor(t,i){this.array=t,this.size=i,this.values=t.slice(0,i),this.startIndex=0}moveTo(t){var t=E.clip(t,0,this.array.length-this.size),i=t+this.size,e=E.clip(t-this.startIndex,-this.size,this.size);0<e?(this.values.splice(0,e),this.values.push.apply(this.values,this.array.slice(i-e,i))):e<0&&(this.values.splice(e),this.values.unshift.apply(this.values,this.array.slice(t,t-e))),this.startIndex=t}}class Menu{static EDIT_ARROW_IMAGE={width:12,height:5,buffer:atob("IAcA+fAOAEA=")};static ARROW_SIZE=10;static VALUE_PAD_X=3;constructor(t,i){this.rows=i,this.options=t=Object.assign({x1:10,x2:-20,y1:0,y2:-1,titlePadX:20},t),t.x1=wrap(t.x1,0,bC.getWidth()),t.x2=wrap(t.x2,0,bC.getWidth()),t.y1=wrap(t.y1,0,bC.getHeight()),t.y2=wrap(t.y2,0,bC.getHeight()),t.rowHeight=t.compact?25:27,this.visibleRows=new CachingWindow(i,0|Math.min((t.y2-t.y1-2*Menu.ARROW_SIZE)/t.rowHeight,i.length)),this.selectedIndex=0,this.isEditing=!1,this.knob1Handler=this.handleKnob1.bind(this)}get selectedRow(){return this.visibleRows.values[this.selectedIndex-this.visibleRows.startIndex]}draw(){var t=this.selectedRow;t&&t.draw&&t.draw(this),bC.reset(),this.options.compact?bC.setFontMonofonto16():bC.setFontMonofonto18();const n=this.options.rowHeight,o=this.options.x1,r=this.options.x2,d=this.options.y1;t=r+o>>1;const c=Menu.ARROW_SIZE,g=this.options.titlePadX,p=n-bC.getFontHeight()>>1,w=this.visibleRows.startIndex;var i=this.visibleRows.values.length,e=w+i,i=(bC.setColor(0<w?3:0).fillPoly([t-c,d+c,t+c,d+c,t,d]),this.visibleRows.values.forEach((t,i)=>{var e,s,h=w+i==this.selectedIndex,a=h&&!this.isEditing,i=d+c+n*i,l=i+n-1;bC.setBgColor(a?3:0).clearRect(o,i,r,l).setColor(a?0:3).setFontAlign(-1,-1).drawString(t.title,o+g,i+p),null!=t.value&&(a=t.format?t.format(t.value):t.value,t=h&&this.isEditing,h=Menu.EDIT_ARROW_IMAGE,e=t?r-2*h.width:r,s=Menu.VALUE_PAD_X,t&&bC.setBgColor(3).clearRect(e-bC.stringWidth(a)-2*s,i,r,l).setColor(0).drawImage(h,e,i+(n-2*h.height>>1),{scale:2}),bC.setFontAlign(1,-1).drawString(a.toString(),e-s,i+p))}),d+c+n*i);bC.setColor(e<this.rows.length?3:0).fillPoly([t-c,i,t+c,i,t,i+c]).flip()}move(t){var i,e;this.isEditing?(e=(i=this.selectedRow).value,i.value-=t*(i.step||1),i.value=E.clip(i.value,i.min,i.max),i.value!=e&&(i.onchange&&i.onchange(i.value,-t),this.draw())):0<this.rows.length&&(e=this.options.wrap?wrap(this.selectedIndex+t,0,this.rows.length-1):E.clip(this.selectedIndex+t,0,this.rows.length-1))!=this.selectedIndex&&(this.selectedIndex=e,this.visibleRows.moveTo(e-(this.visibleRows.size>>1)),this.draw(),Pip.knob1Click(t))}click(){var t,i=this.selectedRow;i&&(Pip.audioStartVar(Pip.audioBuiltin("OK")),"n"==(t=(typeof i.value)[0])?this.isEditing=!this.isEditing:("b"==t&&(i.value=!i.value),i.onchange&&i.onchange(i.value)),this.draw())}handleKnob1(t){t?this.move(-t):this.click()}show(){return bC.clear(1),this.draw(),Pip.on("knob1",this.knob1Handler),this}close(){Pip.removeListener("knob1",this.knob1Handler),Pip.videoStop()}}class Column{constructor(){this.elements=[]}add(t,i){return this.elements.push({draw:t,height:i}),this}replace(t,i,e){t=this.elements[t];return t.draw=i,t.height=e,this}draw(i){i.bottom=i.top,this.elements.forEach(t=>{i.bottom+=t.height,t.draw&&t.draw(i),i.top+=t.height})}}class Entry{constructor(t){this.data=t,this.column=(new Column).add(this.clear.bind(this),0).add(this.drawImage.bind(this),Math.max(120,this.data.h)).add(null,10).add(this.drawDescription.bind(this),100)}get title(){return this.data.t}get description(){return this.data.d}clear(t){bC.reset().clearRect(t.left,t.top,t.right,bC.getHeight())}drawImage(t){var i=t.left+(t.right-10)-this.data.w>>1,t=t.top+3*(t.bottom-t.top-this.data.h)/4;Pip.videoStop(),Pip.videoStart(this.data.f,{x:40+i,y:65+t,repeat:!0})}drawDescription(t){bC.setFont("Vector",12).drawString(bC.wrapString(this.description,t.right-10-(t.left+10)).join("\n"),t.left+10,t.top)}draw(t){this.column.draw({top:0,left:t.options.x2,right:bC.getWidth()})}}